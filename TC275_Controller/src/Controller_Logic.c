/**********************************************************************************************************************
 * \file Controller_Logic.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/

/*-----------------------------------------------------Includes------------------------------------------------------*/
#include "Controller_Logic.h"
#include "TC275_LCD_16x2.h"
#include "Common_def.h"
#include "Message.h"
#include "Data_process.h"
#include <stdio.h>
#include <string.h>
#include <IfxSrc_reg.h>

/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
#define RE_REQUEST_TIME 60 // (sec)
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
uint8 here;
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/


ControllerState g_current_ctrl_state = CTRL_OFF;
TruthState g_isreq_reject = false;
uint32 g_reset_timer = 0;



DriveDir dir_state = DIR_P;


//데이터 무결성 보장을 위해, 통신데이터 저장후 사용


OUR_signal local_udt_req_sig;
OUS_signal local_udt_state_sig;
PS_signal local_prk_status_sig;
EXS_signal local_exit_status_sig;
VS_signal local_vhc_status_sig;

/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
//static void disableUartRxInterrupt() {
//    SRC_ASCLIN0RX.B.SRE = 0;  // ASCLIN0 RX 인터럽트 비활성화
//}
//
//static void enableUartRxInterrupt() {
//    SRC_ASCLIN0RX.B.SRE = 1;  // ASCLIN0 RX 인터럽트 활성화
//}
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/


void Control_Current_State()
{
    {
        msg.move_msg.signal.control_transmission = dir_state;
    }
    {

        // TASK마다 수신 값 최신화
        // 데이터 무결성을 위해, 값 최신화 중 uart수신 인터럽트 비활성화
//        disableUartRxInterrupt();
        if(ready_flag.cgw_ota_udt_req_flag == RECEIVE_COMPLETED)
        {
//            disableUartRxInterrupt();
            memcpy(&local_udt_req_sig, &msg.cgw_ota_udt_req_msg.signal,sizeof(local_udt_req_sig));
            ready_flag.cgw_ota_udt_req_flag = RECEIVE_WAIT;
//            enableUartRxInterrupt();
        }

        if(ready_flag.cgw_ota_udt_state_flag == RECEIVE_COMPLETED)
        {
//            disableUartRxInterrupt();
            memcpy(&local_udt_state_sig, &msg.cgw_ota_udt_state_msg.signal,sizeof(local_udt_state_sig));
            ready_flag.cgw_ota_udt_state_flag = RECEIVE_WAIT;
//            enableUartRxInterrupt();
        }

        if(ready_flag.cgw_prk_status_flag == RECEIVE_COMPLETED)
        {
//            disableUartRxInterrupt();
            memcpy(&local_prk_status_sig, &msg.cgw_prk_status_msg.signal,sizeof(local_prk_status_sig));
            ready_flag.cgw_prk_status_flag = RECEIVE_WAIT;
//            enableUartRxInterrupt();
        }
        if(ready_flag.cgw_exit_status_flag == RECEIVE_COMPLETED)
        {
//            disableUartRxInterrupt();
            memcpy(&local_exit_status_sig, &msg.cgw_exit_status_msg.signal,sizeof(local_exit_status_sig));
            ready_flag.cgw_exit_status_flag = RECEIVE_WAIT;
//            enableUartRxInterrupt();
        }

        if(ready_flag.cgw_vhc_status_flag == RECEIVE_COMPLETED)
        {
//            disableUartRxInterrupt();
            memcpy(&local_vhc_status_sig, &msg.cgw_vhc_status_msg.signal,sizeof(local_vhc_status_sig));
            ready_flag.cgw_vhc_status_flag = RECEIVE_WAIT;
//            enableUartRxInterrupt();
        }

//        enableUartRxInterrupt();
    }

    {
        // 제어버튼, 조향 데이터 최신화
        get_btn_data();
    }


    g_reset_timer++;
    if(g_reset_timer % (RE_REQUEST_TIME * 10) ==0) // 60초
        g_isreq_reject = false;


    switch(g_current_ctrl_state){
    case (CTRL_OFF):
    {
        Show_Off_State();
        break;
    }
    case (CTRL_ON):
    {
        Show_Drive_State();
        break;
    }
    case (CTRL_AUTO_EXIT):
    {
        Show_Auto_Exit_State();
        break;
    }
    case (CTRL_OTA_CONFIRM):
    {
        Show_OTA_Confirm_State();
        break;
    }
    case (CTRL_OTA):
    {
        Show_OTA_State();
        break;
    }
    case (CTRL_AUTO_PARKING):
    {
        Show_Auto_Parking_State();
        break;
    }
    default :
    {
        //LCD 테스트 출력 공간
        LCD1602_clear();
        get_SH_data();
        char str[20];
        sprintf(str,"%d ",
                msg.move_msg.signal.control_steering_angle);
        LCD1602_print(str);
        LCD1602_2ndLine();
//        for(int i=0; i<g_rcv_size;i++)
//        {
//            sprintf(str,"%X ",g_rxData[i]);
//            LCD1602_print(str);
//        }
    }
    }
}

void init_Controller()
{
    //초기화면 설정칸
    init_Btn_Adc();
    init_Steering_Wheel();
    // 실제 데모에선 삭제, OTA original 상태로 만드는 구문!
    writeFlash(OTA_UPDATED);
    //
    readFlash();
    g_current_ctrl_state = CTRL_OFF;
}




/*********************************************************************************************************************/
